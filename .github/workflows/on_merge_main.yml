name: On merge to main

on:
  push:
    branches:
      - main

jobs:
  deploy-app:
    runs-on: 'ubuntu-latest'
    defaults:
      run:
        shell: bash

    steps:

    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: '0'

    - name: Bump version and push tag
      id: bump-tag
      uses: anothrNick/github-tag-action@1.36.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        INITIAL_VERSION: 1.0.0
      
    - name: Branch name
      run: echo running on branch ${{ github.ref_name }}

    - run: npm install -g yarn

    - run: yarn install 

    - run: yarn build:prod

    - name: Create S3 bucket
      run: aws s3api create-bucket --bucket devnotnull-sls-template--production --region us-east-1 || true

    - name: Copy S3 bucket assets
      run: aws s3 cp ./build s3://devnotnull-sls-template-production --recursive
      
    - run: |
        aws s3api put-bucket-cors --bucket devnotnull-sls-template-production --cors-configuration '{"CORSRules" : [{"AllowedHeaders":["*"],"AllowedMethods":["GET","HEAD", "POST"],"AllowedOrigins":["*"],"ExposeHeaders":[]}]}'

    - run: |
        aws s3api put-bucket-policy --bucket devnotnull-sls-template-production --policy '{"Version": "2008-10-17", "Statement": [{ "Sid": "AllowPublicRead", "Effect": "Allow", "Principal": { "AWS": "*" }, "Action": ["s3:GetObject"], "Resource": ["arn:aws:s3:::devnotnull-ui-production/*" ] }] }'
